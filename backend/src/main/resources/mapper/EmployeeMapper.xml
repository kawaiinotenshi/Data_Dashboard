<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.logistics.mapper.EmployeeMapper">

    <resultMap id="BaseResultMap" type="com.logistics.entity.Employee">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="department_id" property="departmentId" jdbcType="BIGINT"/>
        <result column="salary" property="salary" jdbcType="DOUBLE"/>
        <result column="hire_date" property="hireDate" jdbcType="DATE"/>
        <result column="created_time" property="createdTime" jdbcType="TIMESTAMP"/>
        <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="INTEGER"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
    </resultMap>

    <resultMap id="EmployeeWithDepartmentResultMap" type="com.logistics.entity.Employee" extends="BaseResultMap">
        <association property="department" javaType="com.logistics.entity.Department">
            <id column="dept_id" property="id" jdbcType="BIGINT"/>
            <result column="dept_name" property="name" jdbcType="VARCHAR"/>
            <result column="dept_description" property="description" jdbcType="VARCHAR"/>
        </association>
    </resultMap>

    <select id="getEmployeeWithDepartment" resultMap="EmployeeWithDepartmentResultMap">
        SELECT 
            e.*,
            d.id AS dept_id,
            d.name AS dept_name,
            d.description AS dept_description
        FROM employee e
        LEFT JOIN department d ON e.department_id = d.id
        WHERE e.id = #{id}
    </select>

    <select id="getAllEmployeesWithDepartment" resultMap="EmployeeWithDepartmentResultMap">
        SELECT 
            e.*,
            d.id AS dept_id,
            d.name AS dept_name,
            d.description AS dept_description
        FROM employee e
        LEFT JOIN department d ON e.department_id = d.id
        ORDER BY e.created_time DESC
    </select>

    <select id="searchEmployees" resultMap="EmployeeWithDepartmentResultMap">
        SELECT 
            e.*,
            d.id AS dept_id,
            d.name AS dept_name,
            d.description AS dept_description
        FROM employee e
        LEFT JOIN department d ON e.department_id = d.id
        WHERE 1=1
        <if test="name != null and name != ''">
            AND e.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="departmentId != null">
            AND e.department_id = #{departmentId}
        </if>
        <if test="minSalary != null">
            AND e.salary &gt;= #{minSalary}
        </if>
        <if test="maxSalary != null">
            AND e.salary &lt;= #{maxSalary}
        </if>
        ORDER BY e.created_time DESC
    </select>

    <select id="getDepartmentStatistics" resultType="java.util.Map">
        SELECT 
            d.id AS departmentId,
            d.name AS departmentName,
            COUNT(e.id) AS employeeCount,
            COALESCE(AVG(e.salary), 0) AS averageSalary,
            COALESCE(SUM(e.salary), 0) AS totalSalary
        FROM department d
        LEFT JOIN employee e ON d.id = e.department_id
        GROUP BY d.id, d.name
        ORDER BY employeeCount DESC
    </select>

    <select id="getHighestPaidEmployee" resultMap="EmployeeWithDepartmentResultMap">
        SELECT 
            e.*,
            d.id AS dept_id,
            d.name AS dept_name,
            d.description AS dept_description
        FROM employee e
        LEFT JOIN department d ON e.department_id = d.id
        ORDER BY e.salary DESC
        LIMIT 1
    </select>

</mapper>